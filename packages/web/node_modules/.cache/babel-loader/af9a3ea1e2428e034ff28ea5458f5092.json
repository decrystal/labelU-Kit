{"ast":null,"code":"import _objectSpread from\"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _regeneratorRuntime from\"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";import _toConsumableArray from\"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";import _asyncToGenerator from\"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{EToolName}from'@label-u/annotation';import{Button,Dropdown,Form,Menu,Select,Tabs}from'antd';import React,{useEffect,useMemo,useState}from'react';import{toolnames,types,toolnameT,toolnameC}from'./constants';import FormEngine from'./formEngine';import CommonFormItem from'../components/commonFormItems';import{useDispatch,useSelector}from'react-redux';import{LoadInitConfig}from'../configTemplate/config';import{updateAllAttributeConfigList,updatecCommonAttributeConfigurable,updateFileInfo,updateTagConfigList,updateTextConfig,updateToolsConfig}from'../../../stores/toolConfig.store';import'../index.less';import{validateTools}from'../../../utils/tool/common';import{jsx as _jsx}from\"@emotion/react/jsx-runtime\";import{jsxs as _jsxs}from\"@emotion/react/jsx-runtime\";var Option=Select.Option;var noCommonConfigTools=['tagTool','textTool'];var nodrawOutsideTargetTools=['lineTool'];var FormConfig=function FormConfig(props){var _useSelector=useSelector(function(state){return state.toolsConfig;}),tools=_useSelector.tools,tagList=_useSelector.tagList,attribute=_useSelector.attribute,textConfig=_useSelector.textConfig,commonAttributeConfigurable=_useSelector.commonAttributeConfigurable;var dispatch=useDispatch();var children=[];var _useState=useState('图片'),_useState2=_slicedToArray(_useState,2),media=_useState2[0],setMedia=_useState2[1];var _useState3=useState([]),_useState4=_slicedToArray(_useState3,2),selectTools=_useState4[0],setSelectTools=_useState4[1];// const [curentTool, setCurrentTool] = useState<string>();\nvar _useState5=useState(true),_useState6=_slicedToArray(_useState5,2),isConfigLoad=_useState6[0],setIsConfigLoad=_useState6[1];for(var i=0;i<types.length;i++){children.push(_jsx(Option,{children:types[i]},types[i]));}var _useState7=useState(0),_useState8=_slicedToArray(_useState7,2),force=_useState8[0],forceSet=_useState8[1];var items=useMemo(function(){var items=[];var _loop=function _loop(i){if(selectTools.indexOf(toolnameT[toolnames[i]])<0){items.push({key:toolnameT[toolnames[i]],label:_jsx(\"div\",{onClick:function onClick(e){updateSelectTools(toolnameT[toolnames[i]]);loadInitConfig(toolnameT[toolnames[i]],tools);e.stopPropagation();},style:{paddingTop:5,paddingBottom:5,paddingLeft:12},children:_jsx(\"span\",{children:toolnames[i]})})});}};for(var _i=0;_i<toolnames.length;_i++){_loop(_i);}return items;},[selectTools,tools]);var loadInitConfig=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee2(toolname,tools){return _regeneratorRuntime().wrap(function _callee2$(_context2){while(1)switch(_context2.prev=_context2.next){case 0:setIsConfigLoad(false);_context2.next=3;return new Promise(/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(resolve,reject){var config,keys,_i2,_keys,key,newTools;return _regeneratorRuntime().wrap(function _callee$(_context){while(1)switch(_context.prev=_context.next){case 0:if(!toolname){_context.next=7;break;}_context.next=3;return LoadInitConfig(toolname);case 3:config=_context.sent;keys=Object.keys(config);for(_i2=0,_keys=keys;_i2<_keys.length;_i2++){key=_keys[_i2];if(key==='attribute'&&attribute.length===0){dispatch(updateAllAttributeConfigList(config[key]));}else if(key==='tagList'&&tagList.length===0){dispatch(updateTagConfigList(config[key]));}else if(key==='textConfig'&&textConfig.length===0){dispatch(updateTextConfig(config[key]));}else if(key==='tools'){newTools=_toConsumableArray(tools).concat(config[key]);dispatch(updateToolsConfig(newTools));}else if(key==='fileInfo'){dispatch(updateFileInfo(config[key]));}}resolve(config);case 7:case\"end\":return _context.stop();}},_callee);}));return function(_x3,_x4){return _ref2.apply(this,arguments);};}());case 3:setIsConfigLoad(true);case 4:case\"end\":return _context2.stop();}},_callee2);}));return function loadInitConfig(_x,_x2){return _ref.apply(this,arguments);};}();useEffect(function(){var toolArr=[];if(tools&&tools.length>0){for(var _i3=0;_i3<tools.length;_i3++){if(selectTools.indexOf(tools[_i3].tool)<0&&toolArr.indexOf(tools[_i3].tool)<0){toolArr.push(tools[_i3].tool);}}var newTools=_toConsumableArray(selectTools).concat(toolArr);if(tagList.length===0){newTools=newTools.filter(function(tool){return tool!==EToolName.Tag;});}if(textConfig.length===0){newTools=newTools.filter(function(tool){return tool!==EToolName.Text;});}setSelectTools(newTools);// setCurrentTool(newTools[newTools.length - 1]);\n}},[tools,tagList,textConfig]);var updateSelectTools=function updateSelectTools(toolname){var tmp=selectTools;if(tmp.indexOf(toolname)>=0){tmp.splice(tmp.indexOf(toolname),1);}else{tmp.push(toolname);// setCurrentTool(toolname);\n}setSelectTools(tmp);};var _useState9=useState(0),_useState10=_slicedToArray(_useState9,2),height=_useState10[0],setHeight=_useState10[1];useEffect(function(){var leftSiderDom=document.getElementById('lefeSiderId');var height=leftSiderDom===null||leftSiderDom===void 0?void 0:leftSiderDom.getBoundingClientRect().height;setHeight(height-128);},[]);var handleChange=function handleChange(e){setMedia(e);};var updateCombineToolsConfig=function updateCombineToolsConfig(tools,config,toolname){var newTools=tools.reduce(function(res,item){if(item.tool===toolname||toolname==='commonForm'){var copyItem=_objectSpread({},item);var newConfig=_objectSpread(_objectSpread({},copyItem.config),config);copyItem.config=newConfig;res.push(copyItem);}else{res.push(item);}return res;},[]);dispatch(updateToolsConfig(newTools));};var actUpdateToolsConfig=function actUpdateToolsConfig(name,info){if(name&&Object.keys(toolnameC).indexOf(name)>=0){if(name==='tagTool'){dispatch(updateTagConfigList(info.values.tagList));}else if(name==='textTool'){dispatch(updateTextConfig(info.values.textConfig));}else{updateCombineToolsConfig(tools,info.values,name);}}if(name==='commonForm'){if(info.values.attribute!==undefined){dispatch(updateAllAttributeConfigList(info.values.attribute));}dispatch(updatecCommonAttributeConfigurable(info.values.commonAttributeConfigurable));var commonToolConfig={};if(info.values.drawOutsideTarget!==undefined){commonToolConfig=Object.assign(commonToolConfig,{drawOutsideTarget:info.values.drawOutsideTarget});}if(info.values.textConfigurableContext!==undefined){commonToolConfig=Object.assign(commonToolConfig,info.values.textConfigurableContext);}updateCombineToolsConfig(tools,commonToolConfig,name);}};return _jsxs(\"div\",{className:\"formConfig\",style:{height:height},children:[_jsxs(\"div\",{className:\"oneRow\",children:[_jsx(\"label\",{children:\"\\u6807\\u6CE8\\u7C7B\\u578B\"}),_jsx(Select,{size:\"middle\",value:media,onChange:handleChange,listItemHeight:10,listHeight:250,children:children})]}),_jsxs(\"div\",{className:\"oneRow\",children:[_jsx(\"label\",{children:\"\\u6807\\u6CE8\\u5DE5\\u5177\"}),_jsx(Dropdown,{overlay:_jsx(Menu,{items:items}),placement:\"bottomLeft\",trigger:['click'],children:_jsxs(Button,{type:\"primary\",ghost:true,children:[_jsx(\"span\",{style:{fontSize:22,marginTop:-7},children:\"+ \"}),\" \\u65B0\\u589E\\u5DE5\\u5177\"]})})]}),selectTools&&selectTools.length>0&&validateTools(tools)&&_jsx(\"div\",{className:\"formTabBox\",children:_jsx(Tabs// onChange={onChange}\n,{type:\"card\",activeKey:// fix: 未初始化tab切换页面\nlocalStorage.getItem('activeTabKeys')&&Number(localStorage.getItem('activeTabKeys'))<=selectTools.length?localStorage.getItem('activeTabKeys'):selectTools.length+'',onChange:function onChange(e){localStorage.setItem('activeTabKeys',e);forceSet(new Date().getTime());},items:selectTools.map(function(_,i){var id=String(i+1);// 配置初始化\nvar initC={};var configArr=[];var isShow=true;configArr=tools.filter(function(item){return item.tool===_;});initC=configArr[0];// 公共配置\nvar commonConfig={drawOutsideTarget:false,textCheckType:1,customFormat:'',textConfigurable:true};if(noCommonConfigTools.indexOf(_)>=0){//@ts-ignore\nisShow=false;}else{if(initC&&initC.config){commonConfig={//@ts-ignore\ndrawOutsideTarget:initC.config.drawOutsideTarget,//@ts-ignore\ntextCheckType:initC.config.textCheckType,//@ts-ignore\ncustomFormat:initC.config.customFormat,//@ts-ignore\ntextConfigurable:initC.config.textConfigurable};if(nodrawOutsideTargetTools.indexOf(_)>=0){//@ts-ignore\ndelete commonConfig['drawOutsideTarget'];}}}return{//@ts-ignore\nlabel:\"\".concat(toolnameC[_]),key:id,children:_jsx(\"div\",{className:\"toolConfigPane\",children:_jsxs(Form.Provider,{onFormFinish:function onFormFinish(name,info){if(Object.keys(info.forms).length>0){// todo 统一处理表单 和  标注工具之间联动\nactUpdateToolsConfig(name,info);}},children:[_jsx(FormEngine,{toolname:_,config:initC}),isConfigLoad&&_jsx(CommonFormItem,_objectSpread(_objectSpread({commonAttributeConfigurable:commonAttributeConfigurable,attribute:attribute},commonConfig),{},{name:\"commonForm\",toolName:_,isShow:isShow}),force)]})})};})})})]});};export default FormConfig;","map":null,"metadata":{},"sourceType":"module"}