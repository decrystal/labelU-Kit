{"ast":null,"code":"import _slicedToArray from \"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport _regeneratorRuntime from \"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _toConsumableArray from \"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/toConsumableArray.js\";\nimport _createForOfIteratorHelper from \"/Users/decrytal-ade/project/work/shlab/labelU-Kit/packages/web/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper.js\";\nimport { getFormatSize as st } from \"../../components/customResizeHook/index.js\";\nimport { ANNOTATION_ACTIONS as l } from \"../Actions.js\";\nimport { jsonParser as M } from \"../../utils/index.js\";\nimport K from \"../../utils/AnnotationDataUtils.js\";\nimport { composeResultWithBasicImgInfo as it, composeResult as lt } from \"../../utils/data.js\";\nimport $ from \"../../utils/StepUtils.js\";\nimport { CommonToolUtils as rt, AnnotationEngine as ut, cTool as at, ImgUtils as ct } from \"@label-u/annotation\";\nimport { i18n as k } from \"@label-u/utils\";\nimport { message as q } from \"antd/es\";\nimport dt from \"lodash\";\nimport { SetAnnotationLoading as W } from \"./actionCreators.js\";\nvar pt = Object.defineProperty,\n  gt = Object.defineProperties,\n  ft = Object.getOwnPropertyDescriptors,\n  J = Object.getOwnPropertySymbols,\n  _t = Object.prototype.hasOwnProperty,\n  It = Object.prototype.propertyIsEnumerable,\n  Q = function Q(t, e, s) {\n    return e in t ? pt(t, e, {\n      enumerable: !0,\n      configurable: !0,\n      writable: !0,\n      value: s\n    }) : t[e] = s;\n  },\n  r = function r(t, e) {\n    for (var s in e || (e = {})) _t.call(e, s) && Q(t, s, e[s]);\n    if (J) {\n      var _iterator = _createForOfIteratorHelper(J(e)),\n        _step;\n      try {\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var s = _step.value;\n          It.call(e, s) && Q(t, s, e[s]);\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    }\n    return t;\n  },\n  u = function u(t, e) {\n    return gt(t, ft(e));\n  },\n  tt = function tt(t, e, s) {\n    return new Promise(function (p, g) {\n      var _ = function _(f) {\n          try {\n            S(s.next(f));\n          } catch (y) {\n            g(y);\n          }\n        },\n        E = function E(f) {\n          try {\n            S(s.throw(f));\n          } catch (y) {\n            g(y);\n          }\n        },\n        S = function S(f) {\n          return f.done ? p(f.value) : Promise.resolve(f.value).then(_, E);\n        };\n      S((s = s.apply(t, e)).next());\n    });\n  };\nvar mt = at.EVideoToolName,\n  b = function b(t, e) {\n    return t.find(function (s) {\n      return s.step === e;\n    });\n  },\n  et = {\n    isShowOrder: !1,\n    currentToolName: \"\",\n    annotationEngine: null,\n    toolInstance: null,\n    imgList: [],\n    tagConfigList: [],\n    attributeList: [],\n    toolsBasicConfig: [],\n    textConfig: [],\n    config: \"{}\",\n    imgIndex: 0,\n    basicIndex: 0,\n    imgPageSize: 1,\n    step: 1,\n    stepList: [],\n    imgNode: {},\n    basicResultList: [],\n    resultList: [],\n    stepProgress: 0,\n    loading: !1,\n    triggerEventAfterIndexChanged: !1\n  };\ntypeof Image != \"undefined\" && (et.imgNode = new Image());\nvar Tt = function Tt(t) {\n    var e = t.imgList,\n      s = t.imgPageSize;\n    return Math.ceil(e.length / s);\n  },\n  ot = function ot(t, e) {\n    return t.reduce(function (s, p) {\n      if (p) {\n        var g = p.result;\n        if (M(g)[\"step_\".concat(e)]) return s + 1;\n      }\n      return s;\n    }, 0) / t.length;\n  },\n  Lt = function Lt(t, e, s) {\n    var p, g, _;\n    var E = t.step,\n      S = t.stepList,\n      f = t.attributeList,\n      y = t.tagConfigList,\n      h = t.toolInstance,\n      P = t.toolsBasicConfig,\n      x = t.isShowOrder,\n      N = $.getCurrentStepInfo(E, S);\n    h && ((p = h.eventUnbinding) == null || p.call(h));\n    var j = N.config;\n    if (Object.values(mt).includes(N.tool)) return;\n    var U = document.getElementById(\"toolContainer\");\n    if (!U) throw \"Not exist dom named id-toolContainer\";\n    var G = st({\n      width: window == null ? void 0 : window.innerWidth,\n      height: window == null ? void 0 : window.innerHeight\n    });\n    var C = [];\n    if (f && f.length > 0 && (C = [].concat(_toConsumableArray(C), _toConsumableArray(f))), P && P.length > 0) for (var n = 0; n < P.length; n++) ((g = P[n].config) == null ? void 0 : g.attributeList) && (C = [].concat(_toConsumableArray(C), _toConsumableArray((_ = P[n].config) == null ? void 0 : _.attributeList)));\n    var o = new ut({\n      container: U,\n      isShowOrder: x,\n      toolName: N.tool,\n      size: G,\n      imgNode: e,\n      config: j,\n      style: s,\n      tagConfigList: y,\n      attributeList: f,\n      allAttributesList: C\n    });\n    return {\n      toolInstance: o == null ? void 0 : o.toolInstance,\n      annotationEngine: o\n    };\n  },\n  vt = function vt(t, e) {\n    return function (s, p) {\n      return tt(void 0, null, /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var _p$annotation, g, _, E;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              _p$annotation = p().annotation, g = _p$annotation.stepList, _ = _p$annotation.step, E = $.currentToolIsVideo(_, g);\n              if (!(W(s, !0), s(Et(t)), E)) {\n                _context.next = 4;\n                break;\n              }\n              s(St(t));\n              return _context.abrupt(\"return\");\n            case 4:\n              s(At(t, e));\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }));\n    };\n  },\n  Et = function Et(t) {\n    return function (e, s) {\n      return tt(void 0, null, /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var _s$annotation, p, g, _;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              _s$annotation = s().annotation, p = _s$annotation.getFileData, g = _s$annotation.imgList;\n              if (!p) {\n                _context2.next = 6;\n                break;\n              }\n              _context2.next = 4;\n              return p(g[t], t);\n            case 4:\n              _ = _context2.sent;\n              e({\n                type: l.SET_FILE_DATA,\n                payload: {\n                  fileData: _,\n                  index: t\n                }\n              });\n            case 6:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2);\n      }));\n    };\n  },\n  St = function St(t) {\n    return function (e) {\n      W(e, !1), e({\n        type: l.LOAD_FILE_DATA,\n        payload: {\n          nextIndex: t\n        }\n      });\n    };\n  },\n  At = function At(t, e) {\n    return function (s, p) {\n      var g;\n      var _p$annotation2 = p().annotation,\n        _ = _p$annotation2.toolInstance,\n        E = _p$annotation2.imgList,\n        S = (g = E == null ? void 0 : E[t]) == null ? void 0 : g.url;\n      ct.load(S).then(function (f) {\n        W(s, !1), s({\n          type: l.LOAD_FILE_DATA,\n          payload: {\n            imgNode: f,\n            nextIndex: t,\n            nextBasicIndex: e\n          }\n        });\n      }).catch(function () {\n        W(s, !1), _ == null || _.setErrorImg(), s({\n          type: l.LOAD_FILE_DATA,\n          payload: {\n            nextIndex: t,\n            nextBasicIndex: e\n          }\n        });\n      });\n    };\n  },\n  Dt = function Dt() {\n    var t = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : et;\n    var e = arguments.length > 1 ? arguments[1] : undefined;\n    var s, p, g, _, E, S, f, y, h, P, x, N, j, U, G, C;\n    switch (e.type) {\n      case l.UPDATE_TOOL_INSTANCE:\n        return u(r({}, t), {\n          toolInstance: e.payload.toolInstance\n        });\n      case l.UPDATE_TEXT_CONFIG:\n        return u(r({}, t), {\n          textConfig: e.payload.textConfig\n        });\n      case l.UPDATE_ATTRIBUTE_LIST:\n        return u(r({}, t), {\n          attributeList: e.payload.attributeList\n        });\n      case l.UPDATE_TOOLS_CONFIG:\n        return u(r({}, t), {\n          toolsBasicConfig: e.payload.toolsBasicConfig\n        });\n      case l.UPDATE_CURRENT_TOOLNAME:\n        return u(r({}, t), {\n          currentToolName: e.payload.toolName\n        });\n      case l.UPDATE_IS_SHOW_ORDER:\n        return u(r({}, t), {\n          isShowOrder: e.payload.isShowOrder\n        });\n      case l.UPDATE_TAG_LIST:\n        return u(r({}, t), {\n          tagConfigList: e.payload.tagConfigList\n        });\n      case l.UPDATE_IMG_LIST:\n        return u(r({}, t), {\n          imgList: e.payload.imgList\n        });\n      case l.CALC_STEP_PROGRESS:\n        {\n          var o = t.imgList,\n            n = t.step,\n            i = ot(o, n);\n          return u(r({}, t), {\n            stepProgress: i\n          });\n        }\n      case l.SUBMIT_FILE_DATA:\n        {\n          var _o = t.imgList,\n            _n = t.imgIndex,\n            _i = t.step,\n            a = t.stepList,\n            c = t.toolInstance,\n            d = t.onSubmit,\n            m = t.resultList;\n          if (!c || !_o[_n]) return t;\n          var I = ((s = _o[_n]) == null ? void 0 : s.result) || \"\",\n            _ref = (p = c == null ? void 0 : c.exportData()) != null ? p : [],\n            _ref2 = _slicedToArray(_ref, 2),\n            L = _ref2[1],\n            v = it(I, L),\n            A = lt(v, {\n              step: _i,\n              stepList: a\n            }, {\n              rect: m\n            });\n          _o[_n].result = K.dataCorrection(A, I, _i, a), d && d([_o[_n]], (g = e.payload) == null ? void 0 : g.submitType, _n);\n          var T = ot(_o, _i);\n          return u(r({}, t), {\n            stepProgress: T,\n            imgList: _o\n          });\n        }\n      case l.SAVE_RESULT:\n        {\n          var _o2 = t.imgList,\n            _n2 = t.imgIndex,\n            _i2 = t.onSave;\n          return _i2 == null || _i2(_o2[_n2], _n2, _o2), r({}, t);\n        }\n      case l.SUBMIT_RESULT:\n        {\n          var _o3 = t.imgList,\n            _n3 = t.basicIndex,\n            _i3 = t.resultList,\n            _a = t.toolInstance,\n            _c = t.basicResultList;\n          if (!_a) return t;\n          var _ref3 = (_ = _a == null ? void 0 : _a.exportData()) != null ? _ : [],\n            _ref4 = _slicedToArray(_ref3, 1),\n            _d = _ref4[0];\n          var _m = _d;\n          if ((_c == null ? void 0 : _c.length) > 0) {\n            var _m2;\n            var _I = (E = _c[_n3]) == null ? void 0 : E.id,\n              _L = _d.map(function (v) {\n                return u(r({}, v), {\n                  sourceID: _I\n                });\n              });\n            _m = dt.cloneDeep(_i3).filter(function (v) {\n              return v.sourceID !== _I;\n            }), (_m2 = _m).push.apply(_m2, _toConsumableArray(_L));\n          }\n          return u(r({}, t), {\n            resultList: _m,\n            imgList: _o3\n          });\n        }\n      case l.SET_BASIC_INDEX:\n        {\n          var _o4 = t.toolInstance,\n            _n4 = t.step,\n            _i4 = t.imgList,\n            _a2 = t.imgIndex,\n            _c2 = t.stepList,\n            _d2 = t.annotationEngine,\n            _m3 = t.resultList,\n            _I2 = t.basicResultList;\n          if (!_o4 || !_d2) return t;\n          var _L2 = e.payload.basicIndex,\n            _v = (S = _I2[_L2]) == null ? void 0 : S.id,\n            _A = M((f = _i4[_a2]) == null ? void 0 : f.result),\n            _T = (_m3 || []).filter(function (z) {\n              return z.sourceID === _v;\n            }),\n            D = b(_c2, _n4),\n            w = D.dataSourceStep,\n            X = D.tool,\n            B = b(_c2, w);\n          var R = [];\n          return w && X && (R = (y = _A[\"step_\".concat(w)]) == null ? void 0 : y.result, (R == null ? void 0 : R.length) > 0 ? (_d2 == null || _d2.setBasicInfo(B.tool, R[_L2]), _d2 == null || _d2.launchOperation()) : (_d2 == null || _d2.setBasicInfo(B.tool), _d2 == null || _d2.forbidOperation(), q.info(k.t(\"NoDependency\")))), _o4 == null || _o4.setResult(_T), _o4 == null || _o4.history.initRecord(_T, !0), u(r({}, t), {\n            basicIndex: _L2\n          });\n        }\n      case l.SET_TRIGGER_EVENT_AFTER_INDEX_CHANGED:\n        {\n          var _o5 = e.payload.triggerEventAfterIndexChanged;\n          return u(r({}, t), {\n            triggerEventAfterIndexChanged: !!_o5\n          });\n        }\n      case l.LOAD_FILE_DATA:\n        {\n          var _o6 = t.imgList,\n            _n5 = t.step,\n            _i5 = t.toolInstance,\n            _a3 = t.annotationEngine,\n            _c3 = t.stepList;\n          if (!_i5) return t;\n          var _d3 = $.getCurrentStepInfo(_n5, _c3),\n            _e$payload = e.payload,\n            _m4 = _e$payload.nextIndex,\n            _I3 = _e$payload.imgNode,\n            _L3 = _e$payload.nextBasicIndex,\n            _v2 = _e$payload.imgError,\n            _A2 = _L3 != null ? _L3 : 0,\n            _T2 = M((h = _o6[_m4]) == null ? void 0 : h.result),\n            _D = _T2[_c3[0].tool],\n            _w = !_D,\n            _X = {\n              rotate: (P = _T2.rotate) != null ? P : 0,\n              valid: (x = _T2.valid) != null ? x : !0\n            };\n          _I3 && _v2 !== !0 && (_a3 == null || _a3.setImgNode(_I3, _X));\n          var _B = b(_c3, _n5),\n            _R = _B.dataSourceStep,\n            z = _B.tool,\n            Y = b(_c3, _R),\n            Z = _R && z,\n            O = Object.keys(_T2).reduce(function (H, F) {\n              return F.indexOf(\"Tool\") > 0 && F !== z && H.push(_T2[F]), H;\n            }, []),\n            V = K.getInitialResultList(_D == null ? void 0 : _D.result, _i5, _B, O, _w);\n          if (O && O.length > 0 ? _a3 == null || _a3.setPrevResultList(O) : _a3 == null || _a3.setPrevResultList([]), Z && ((O == null ? void 0 : O.length) > 0 ? _a3 == null || _a3.setBasicInfo(Y.tool, O[_A2]) : (_a3 == null || _a3.setBasicInfo(Y.tool), _a3 == null || _a3.forbidOperation(), q.info(k.t(\"NoDependency\")))), _d3.tool !== \"check\") {\n            var H = (j = (N = O[_A2]) == null ? void 0 : N.id) != null ? j : \"\",\n              F = Z ? V.filter(function (nt) {\n                return rt.isSameSourceID(nt.sourceID, H);\n              }) : V;\n            _i5 == null || _i5.setResult(F), _i5 == null || _i5.history.initRecord(V, !0);\n          }\n          return u(r({}, t), {\n            imgIndex: _m4,\n            basicIndex: _A2,\n            basicResultList: O,\n            resultList: V\n          });\n        }\n      case l.UPDATE_ANNOTATION_CONFIG:\n        return u(r({}, t), {\n          config: (U = e.payload.config) != null ? U : \"{}\"\n        });\n      case l.SET_TASK_CONFIG:\n        {\n          var _e$payload2 = e.payload,\n            _o7 = _e$payload2.stepList,\n            _n6 = _e$payload2.step;\n          return u(r({}, t), {\n            stepList: _o7,\n            step: _n6\n          });\n        }\n      case l.INIT_TOOL:\n        {\n          var _o8 = e.payload.toolStyle,\n            _n7 = t.imgNode,\n            _i6 = Lt(t, _n7, _o8);\n          if (_i6) {\n            var _a4 = _i6.toolInstance,\n              _c4 = _i6.annotationEngine;\n            return u(r({}, t), {\n              toolInstance: _a4,\n              annotationEngine: _c4\n            });\n          }\n          return r({}, t);\n        }\n      case l.SET_TOOL:\n        {\n          var _o9 = (G = e.payload) == null ? void 0 : G.instance;\n          return _o9 ? u(r({}, t), {\n            toolInstance: _o9\n          }) : r({}, t);\n        }\n      case l.UPDATE_ON_SUBMIT:\n        return u(r({}, t), {\n          onSubmit: e.payload.onSubmit\n        });\n      case l.UPDATE_ON_SAVE:\n        return u(r({}, t), {\n          onSave: e.payload.onSave\n        });\n      case l.UPDATE_ON_PAGE_CHANGE:\n        return u(r({}, t), {\n          onPageChange: e.payload.onPageChange\n        });\n      case l.UPDATE_ON_STEP_CHANGE:\n        return u(r({}, t), {\n          onStepChange: e.payload.onStepChange\n        });\n      case l.UPDATE_GET_FILE_DATA:\n        return u(r({}, t), {\n          getFileData: e.payload.getFileData\n        });\n      case l.UPDATE_PAGE_SIZE:\n        return u(r({}, t), {\n          pageSize: e.payload.pageSize\n        });\n      case l.UPDATE_LOAD_FILE_LIST:\n        return u(r({}, t), {\n          loadFileList: e.payload.loadFileList\n        });\n      case l.SET_FILE_DATA:\n        {\n          var _e$payload3 = e.payload,\n            _o10 = _e$payload3.fileData,\n            _n8 = _e$payload3.index,\n            _i7 = t.imgList;\n          return _i7[_n8] = r(r({}, _i7[_n8]), _o10), u(r({}, t), {\n            imgList: _i7\n          });\n        }\n      case l.UPDATE_ROTATE:\n        {\n          var _o11 = t.toolInstance;\n          return _o11 == null || _o11.updateRotate(), t;\n        }\n      case l.COPY_BACKWARD_RESULT:\n        {\n          var _o12 = t.toolInstance,\n            _n9 = t.imgIndex,\n            _i8 = t.imgList,\n            _a5 = t.step,\n            _c5 = t.currentToolName;\n          if (!_o12) return t;\n          if (_n9 === 0 || _n9 >= _i8.length) return console.error(\"\\u65E0\\u6CD5\\u590D\\u5236\\u8FB9\\u754C\\u5916\\u7684\\u5185\\u5BB9\"), t;\n          var _d4 = _i8[_n9 - 1].result;\n          if (!_d4) return t;\n          var _m5 = K.copyResultChange(_d4, _a5, (C = _i8[_n9].result) != null ? C : \"\");\n          _i8[_n9].result = _m5;\n          var _I4 = M(_m5),\n            _L4 = Object.keys(_I4).reduce(function (T, D) {\n              return D.indexOf(\"Tool\") > 0 && D !== _c5 && T.push(_I4[D]), T;\n            }, []),\n            _v3 = _I4[_c5],\n            _A3 = (_v3 == null ? void 0 : _v3.result) || [];\n          return _o12 == null || _o12.setResult(_A3), _o12 == null || _o12.setPrevResultList(_L4), _o12 == null || _o12.history.pushHistory(_A3), u(r({}, t), {\n            imgList: _toConsumableArray(_i8)\n          });\n        }\n      case l.SET_STEP:\n        {\n          var _o13 = t.stepList,\n            _n10 = t.annotationEngine,\n            _i9 = e.payload.toStep;\n          if (!_n10) return t;\n          var _a6 = b(_o13, _i9);\n          return _n10 == null || _n10.setToolName(_a6.tool, _a6.config), u(r({}, t), {\n            step: _i9,\n            toolInstance: _n10 == null ? void 0 : _n10.toolInstance\n          });\n        }\n      case l.SET_LOADING:\n        {\n          var _o14 = e.payload.loading;\n          return u(r({}, t), {\n            loading: !!_o14\n          });\n        }\n      default:\n        return t;\n    }\n  };\nexport { vt as LoadFileAndFileData, Dt as annotationReducer, b as getStepConfig, Tt as getTotalPage };","map":null,"metadata":{},"sourceType":"module"}